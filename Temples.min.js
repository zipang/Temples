/**
 * Temples.js
 * ============
 * Author: Eidolon Labs (zipang)
 * Source : http://github.com/zipang/Temples
 * Date: 2013-11-25
 * v0.2.1
 */
!function(context,$){if(!$)throw"Temples relies on a jQuery compatible DOM search engine and DOM manipulator";var templates=[];if(!console)window.console={log:function(){}};var stringProto=String.prototype;stringProto.startsWith=stringProto.startsWith||function(str){return this.indexOf(str)===0};stringProto.contains=stringProto.contains||function(str){return this.indexOf(str)!==-1};function displayNode(elt){if(!elt)return"undefined";var tagName=elt.tagName,id=elt.id,className=elt.className;return tagName+(id?"#"+id:"")+(className?"."+className:"")}function comment(cm){return $("<!--"+cm+"-->")}function evalProperty(path,data,$elt){var key,parent,found=data,steps=(path||"").trim().split(".");while(found&&(key=steps.shift())){parent=found;found=found[key]}return typeof found=="function"?found.call(parent,$elt):found||""}function Renderer(){}Renderer.prototype={render:function(data){var bindings=this.bindings,l=bindings.length;for(var i=0;i<l;i++){bindings[i](data)}return this.$root},output:function(data){this.render(data);var output=[];try{this.$root.each(function(i,elt){output.push(elt.outerHTML)})}catch(e){if(XMLSerializer){var serializer=new XMLSerializer;this.$root.each(function(i,elt){output.push(serializer.serializeToString(elt))})}}return output.join("")},toHtml:function(){return this.$root.html()},destroy:function(){this.bindings=this.$root=null;if(this.name){delete Temples[this.name];templates.splice(templates.indexOf(this.name),1)}},toString:function(s){if(s)this.toString=function(){return s};else return"Renderer"}};function AttributeRenderer($elt,expr){this.$root=$elt;this.bindings=[Bindings.updater($elt,expr)];this.toString("AttributeRenderer("+displayNode($elt[0])+"["+expr+"])")}AttributeRenderer.prototype=new Renderer;function SimpleElementRenderer($elt,dataBind){this.$root=$elt;this.toString("SimpleElementRenderer("+displayNode($elt[0])+"["+dataBind+"])");var bindings=this.bindings=[],expr,exprList=dataBind.split(",");while(expr=exprList.pop())bindings.push(Bindings.updater($elt,expr.trim()))}SimpleElementRenderer.prototype=new Renderer;function ConditionalElementRenderer($elt,cond,dataBind){if(!arguments.length)return;this.$root=$elt;this.condition=cond;var conditionalbindings=this.conditionalbindings=[];this.toString("ConditionalElementRenderer("+displayNode($elt[0])+"["+dataBind+"] if "+cond+")");if(dataBind){var exprList=dataBind.split(",");for(var i=0,expr;expr=exprList[i++];){conditionalbindings.push(Bindings.updater($elt,expr.trim()))}}var self=this;this.bindings=[function(data){if(evalProperty(cond,data)){for(var i=0,render;render=conditionalbindings[i++];){render(data)}self.reappear()}else{self.disappear("Temples says: "+cond+"=false")}}]}$.extend(ConditionalElementRenderer.prototype=new Renderer,{disappear:function(why){if(!this.placeHolder){this.$root.replaceWith(this.placeHolder=comment(why))}},reappear:function(){if(this.placeHolder){this.placeHolder.replaceWith(this.$root);this.placeHolder=null}}});function ListRenderer($elt,loopExpr,cond,dataBind){this.$root=$elt;var renderBlock=$elt.children().first();if(!renderBlock.length)throw"List Renderer "+displayNode($elt[0])+" for ("+loopExpr+") must have at least a child block!";var template=this.template=new TemplateRenderer(this.toString(),renderBlock);this.toString("ListRenderer("+displayNode($elt[0])+"["+dataBind+"] if "+cond+")\n"+"iterate "+loopExpr+" with "+template);var expr=loopExpr.replace("from",":"),parts=expr.split(":"),collectionPath=parts[1]||parts[0];var seed=this.seed=collectionPath.trim();if(parts.length==2){this.varName=parts[0].trim()}else{this.varName=this.seed.split(".").pop();this.varName=this.varName.replace(/s*$/,"")}var varName=this.varName;ConditionalElementRenderer.call(this,$elt,cond,dataBind);this.conditionalbindings.push(function(data){var collection=evalProperty(seed,data);$elt.empty();for(var i=0,l=collection.length;i<l;i++){data[varName]=collection[i];$elt.append(template.render(data).clone())}delete data[varName]})}ListRenderer.prototype=new ConditionalElementRenderer;Renderer.isListRenderer=ListRenderer.loopExpression=function($elt){try{return $elt.attr("data-iterate")||$elt.attr("data-each")}catch(err){return""}};function TemplateRenderer(name,$elts){this.$root=$elts||name;if($elts)this.name=name;this.toString("TemplateRenderer("+($elts?this.name+", ":"")+displayNode($elts[0])+")");var bindings=this.bindings=[];$elts.each(function(i,elt){var $targets=Renderer.targets($(elt));$targets.each(function(i,elt){var renderer=Renderer.Factory($(elt));if(renderer)Array.prototype.push.apply(bindings,renderer.bindings)})})}TemplateRenderer.prototype=new Renderer;Renderer.targets=function($root){var isRenderer=function(){return $(this).attr("data-bind")||$(this).attr("data-render-if")},firstLevel=function(){return $(this).parentsUntil($root,"[data-iterate], [data-each]").length==0};if(Renderer.isListRenderer($root)){return $root}else{return $root.filter(isRenderer).add($("*[data-bind], *[data-render-if]",$root).filter(firstLevel)).add($("*[data-iterate], *[data-each]",$root).filter(firstLevel))}};var Bindings={updater:function($elt,expr){console.log("Binding '"+expr+"' for element "+displayNode($elt[0]));var exprParts=expr.split("=");if(exprParts.length==1){var path=exprParts[0],tagName=$elt[0].tagName.toLowerCase();if(tagName=="input"||tagName=="select"){return function(data){$elt.val(evalProperty(path,data,$elt))}}else{return function(data){$elt.html(evalProperty(path,data,$elt))}}}else{var attr=exprParts[0].toLowerCase(),path=exprParts[1];if(attr.startsWith("class")){var classes=/\[([\w|\|]+)\]/g.exec(attr);if(classes){classes=classes[1].split("|").join(" ");return function(data){$elt.removeClass(classes);$elt.addClass(evalProperty(path,data,$elt))}}else{return function(data){$elt.attr("class",evalProperty(path,data,$elt))}}}else if("text|html|value".contains(attr)){return function(data){$elt[attr](evalProperty(path,data,$elt))}}else{return function(data){$elt.attr(attr,evalProperty(path,data,$elt))}}}}};Renderer.Factory=function($elt){var dataBind=$elt.attr("data-bind"),condition=$elt.attr("data-render-if"),loopExpr=$elt.attr("data-iterate")||$elt.attr("data-each");$elt.removeAttr("data-bind data-render-if data-iterate data-each");if(loopExpr){return new ListRenderer($elt,loopExpr,condition,dataBind)}else if(condition){return new ConditionalElementRenderer($elt,condition,dataBind)}else if(dataBind&&dataBind.contains(",")){return new SimpleElementRenderer($elt,dataBind)}else if(dataBind){return new AttributeRenderer($elt,dataBind)}};var Temples={Renderer:TemplateRenderer,prepare:function(name,template){if(!template){if(name.startsWith("#")){template=$(name)}else if(name=="document"){template=$("html")}else if(name.startsWith("<")||name.contains(" ")){template=name;name=undefined}}else if($.fetchDocument){$.fetchDocument(template)}if(name){templates.push(name);return Temples[name]=new Temples.Renderer(name,$(template))}else{return new Temples.Renderer($(template))}},destroy:function(name){if(!name){templates.forEach(Temples.destroy)}else if(Temples[name]){Temples[name].destroy()}},render:function(name,data){if(!data&&typeof name=="object"){data=name;name="document"}(Temples[name]||Temples.prepare(name)).render(data)}};Temples.register=Temples.prepare;if(context===window){context["Temples"]=Temples}else if(module&&module.exports){module.exports=Temples}}(this,this.jQuery||this.ender||this.jquip||require("buck"));
